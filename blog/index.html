<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>stijn's blog</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 2em; max-width: 800px; margin: 0 auto; color: #333; }
        h1, h2 { color: #000; }
        #container { padding: 1em; }
        #back-link { display: block; margin-bottom: 2em; font-weight: bold; }
        a { text-decoration: none; color: #007aff; }
        a:hover { text-decoration: underline; }
        .error { color: #d8000c; background-color: #ffbaba; padding: 1em; border-radius: 5px; }
        .post-content { border-top: 1px solid #eee; padding-top: 2em; margin-top: 2em;}

        /* New styles for the post list */
        .post-list { list-style: none; padding: 0; }
        .post-list-item { display: flex; align-items: baseline; margin-bottom: 0.8em; }
        .post-date { font-family: monospace; min-width: 140px; color: #888; white-space: nowrap; }
        .post-title a { font-weight: 500; }

        /* Styles for blockquotes */
        .post-content blockquote {
            padding: 1em 1.5em;
            margin: 1.5em 0;
            border-left: 5px solid #e0e0e0;
            background-color: #f9f9f9;
            color: #555;
            font-style: italic;
        }
        .post-content blockquote p:first-of-type {
            margin-top: 0;
        }
        .post-content blockquote p:last-of-type {
            margin-bottom: 0;
        }

        /* Responsive video container */
        .video-responsive {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            margin: 1.5em auto; /* Center the container itself */
        }

        .video-responsive iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

    </style>
</head>
<body>
    <h1><a href="#">stijn's blog</a></h1>
    <p><a href="https://stijnheymans.net">Home</a> | <a href="rss.xml">RSS Feed</a></p>
    <div id="container">Loading...</div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const container = document.getElementById('container');

        // Renders a specific markdown file into the container
        async function renderPost(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`File not found: ${filename}`);
                const markdown = await response.text();
                
                container.innerHTML = `
                    <a href="#" id="back-link">&larr; Back to List</a>
                    <div class="post-content">
                        ${marked.parse(markdown)}
                    </div>
                `;
            } catch (error) {
                console.error('Error rendering post:', error);
                container.innerHTML = `<div class="error">Could not load post: ${error.message}</div><a href="#">&larr; Back to List</a>`;
            }
        }

        // Formats a "YYYY-MM-DD" string into "DD Mon, YYYY"
        function formatDate(dateString) {
            // Add a defensive check to prevent crashes
            if (typeof dateString !== 'string' || !dateString.includes('-')) {
                console.warn('formatDate received an invalid dateString:', dateString);
                return 'Invalid Date';
            }
            const [year, month, day] = dateString.split('-');
            // Use T00:00:00 to avoid timezone issues
            const date = new Date(`${year}-${month}-${day}T00:00:00`);
            return date.toLocaleDateString('en-US', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
            });
        }

        // Renders the list of posts from posts.json
        async function renderList() {
            try {
                const response = await fetch('posts.json', { cache: "no-store" }); // Disable cache for posts.json
                if (!response.ok) throw new Error('posts.json not found. Did you run the ./build script?');
                
                const posts = await response.json();

                if (posts.length === 0) {
                    container.innerHTML = "<p>No posts found. Create one with <code>./today</code> and then run <code>./build</code>!</p>";
                    return;
                }
                
                let html = '<ul class="post-list">';
                for (const post of posts) {
                    // Add defensive checks to skip any malformed post objects
                    if (!post || typeof post.date === 'undefined' || typeof post.filename === 'undefined') {
                        console.error('Skipping invalid post object in posts.json:', post);
                        continue; // Skip this iteration of the loop
                    }

                    const title = post.title || post.filename.replace(/\.md$/, ''); // Add a fallback for the title

                    html += `<li class="post-list-item">
                        <span class="post-date">${formatDate(post.date)}</span>
                        <span class="post-title"><a href="#${post.filename}">${title}</a></span>
                    </li>`;
                }
                html += '</ul>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error rendering list:', error);
                container.innerHTML = `<div class="error">Could not load post list: ${error.message}</div>`;
            }
        }

        // Simple router to decide whether to show the list or a post
        function router() {
            const filename = window.location.hash.substring(1);
            if (filename) {
                renderPost(filename);
            } else {
                renderList();
            }
        }

        // Listen for URL hash changes and for initial page load
        window.addEventListener('hashchange', router);
        window.addEventListener('load', router);
    </script>
</body>
</html>
